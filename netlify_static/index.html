<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Adient Loznica PVS (Static)</title>
  <style>
    /* === TV-OPTIMIZED SIZING (65" 4K, 3840x2160) === */
    :root {
      --base-size: 15px;
      --head-size: 1.35rem;
      --group-head-size: 1.5rem;
      --num-size: 1.35rem;
      --line-name-size: 1.15rem;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { margin: 0; font-family: Segoe UI, Roboto, Arial, sans-serif; background: #0a3b41; color: #e8f1f2; font-size: var(--base-size); }

    .container { padding: 8px 24px 6px; height: 100%; display: flex; flex-direction: column; }
    .panel { background: #0e4b52; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); padding: 6px 12px 8px; flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    .page { display: none; flex: 1; display: none; flex-direction: column; }
    .page.active { display: flex; }

    .header { display: flex; align-items: center; justify-content: space-between; padding: 2px 4px 2px; flex-shrink: 0; }
    .header .left { opacity: .9; font-size: 1rem; }
    .header .title { font-size: 2.2rem; letter-spacing: .7px; color: #c8e000; font-weight: 700; }
    .header .right { text-align: right; font-size: 1rem; display: flex; align-items: center; gap: 12px; }

    .btn { background: #0fb; color: #003; border: none; border-radius: 8px; padding: 8px 14px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.25); font-size: 1rem; }
    .btn:hover { filter: brightness(1.08); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg) } }

    .table-wrap { flex: 1; overflow: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; background: #08343a; border-radius: 10px; font-size: var(--num-size); }
    th, td { padding: 4px 8px; text-align: right; white-space: nowrap; }
    td { background: #000000; }
    th { position: sticky; top: 0; z-index: 2; background: #0f5560; color: #e3f2f4; font-weight: 800; font-size: var(--head-size); }
    th.group { background: #0f6a70; color: #d7eced; text-align: center; font-weight: 900; font-size: var(--group-head-size); }
    /* Different header colors per block (3 group <th> elements: MTD, WTD, Daily) */
    thead tr:first-child th.group:nth-of-type(1) { background: #0f6a70; }   /* MTD */
    thead tr:first-child th.group:nth-of-type(2) { background: #154f7a; }   /* WTD */
    thead tr:first-child th.group:nth-of-type(3) { background: #6a5b16; }   /* Daily */
    /* Second header row block colors (rowspan on "Line" means this row has 14 th's after adding OLK columns) */
    thead tr:nth-child(2) th:nth-child(1),
    thead tr:nth-child(2) th:nth-child(2),
    thead tr:nth-child(2) th:nth-child(3),
    thead tr:nth-child(2) th:nth-child(4),
    thead tr:nth-child(2) th:nth-child(5)   { background: #0f6a70; }
    thead tr:nth-child(2) th:nth-child(6),
    thead tr:nth-child(2) th:nth-child(7),
    thead tr:nth-child(2) th:nth-child(8),
    thead tr:nth-child(2) th:nth-child(9)  { background: #154f7a; }
    thead tr:nth-child(2) th:nth-child(10),
    thead tr:nth-child(2) th:nth-child(11),
    thead tr:nth-child(2) th:nth-child(12),
    thead tr:nth-child(2) th:nth-child(13)  { background: #6a5b16; }
    td:first-child, th:first-child { text-align: left; font-size: var(--line-name-size); }

    /* Vertical separators between metric blocks (MTD / WTD / Daily) */
    th:nth-child(2), td:nth-child(2),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(11), td:nth-child(11) {
      border-left: 2px solid rgba(0, 0, 0, 0.55);
    }

    tr:nth-child(even) td { background: #000000; }
    tr:hover td { background: rgba(255,255,255,0.06); }
    .row-dark td:first-child { background: #000; }

    /* Category row colors */
    tr.cat-sew td { background: rgba(180, 60, 60, 0.25); }
    tr.cat-sew:nth-child(even) td { background: rgba(160, 50, 50, 0.30); }
    tr.cat-assy td { background: rgba(40, 100, 140, 0.25); }
    tr.cat-assy:nth-child(even) td { background: rgba(30, 85, 125, 0.30); }
    tr.cat-other td { background: rgba(80, 80, 80, 0.20); }
    tr.cat-other:nth-child(even) td { background: rgba(60, 60, 60, 0.25); }

    /* Category separator row */
    tr.cat-separator td {
      background: #0a3b41 !important;
      height: 6px;
      padding: 0;
      border: none;
    }

    .num { font-variant-numeric: tabular-nums; font-weight: 600; }

    /* Delta colors - static positive/negative (text + left bar) */
    .delta-pos { color: #9cf0a5; border-left: 3px solid rgba(40, 167, 69, 0.9); }
    .delta-neg { color: #ffb3b3; border-left: 3px solid rgba(220, 53, 69, 0.95); }

    .status { display: flex; gap: 18px; font-size: .95rem; color: #cde4e6; }
    .badge { display: inline-flex; align-items: center; gap: 8px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #2ecc71; display: inline-block; }

    .legend { margin-top: 6px; opacity: .9; font-size: 0.9rem; flex-shrink: 0; }

    /* Pie charts container */
    .charts-row {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      gap: 18px;
      margin-top: 8px;
      flex-shrink: 0;
    }
    .chart-box {
      text-align: center;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 10px 16px 12px;
      min-width: 190px;
    }
    .chart-box h3 {
      margin: 0 0 10px;
      font-size: 1.2rem;
      color: #c8e000;
      font-weight: 700;
    }
    .chart-box.sew-chart h3 { color: #ff9999; }
    .chart-box.assy-chart h3 { color: #7dc8e8; }
    .chart-box.total-chart h3 { color: #c8e000; }
    .chart-box.olk-chart h3 { color: #c8e000; }
    .pie-container {
      position: relative;
      width: 130px;
      height: 130px;
      margin: 0 auto;
    }
    .pie-svg {
      background-color: #02252b;
      border-radius: 50%;
      transform: rotate(-90deg) scale(1.25);
      transform-origin: 50% 50%;
    }
    .pie-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
    }
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    .chart-legend span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .legend-dot.sched { background: #3498db; }
    .legend-dot.prod { background: #2ecc71; }

    /* Group pies on page 3 (many small donuts, wrap in rows) */
    .group-charts {
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 12px;
      row-gap: 18px;
    }
    .group-charts .chart-box {
      min-width: 170px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <div class="header">
        <div class="left">
          <div class="badge"><span class="dot"></span> Static snapshot</div>
        </div>
        <div class="title">ADIENT LOZNICA PVS</div>
        <div class="right">
          <button id="refreshBtn" class="btn" onclick="manualRefresh()">Reload snapshot</button>
          <div>
            <div>Snapshot date: <span id="lastUp">-</span></div>
          </div>
        </div>
      </div>

      <!-- Page 1: SEW -->
      <div class="page page-sew active">
        <div class="table-wrap">
          <table id="pvsTableSew">
            <thead id="theadSew"></thead>
            <tbody id="tbodySew"></tbody>
          </table>
        </div>

        <div class="charts-row" id="chartsRowSew">
          <div class="chart-box sew-chart">
            <h3>SEW MTD</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieSewMtd"></svg>
              <div class="pie-center" id="pieSewMtdPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> Sched: <span id="sewMtdSched">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="sewMtdProd">-</span></span>
            </div>
          </div>
          <div class="chart-box sew-chart">
            <h3>SEW WTD</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieSewWtd"></svg>
              <div class="pie-center" id="pieSewWtdPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> Sched: <span id="sewWtdSched">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="sewWtdProd">-</span></span>
            </div>
          </div>
          <div class="chart-box sew-chart">
            <h3>SEW Daily</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieSewDaily"></svg>
              <div class="pie-center" id="pieSewDailyPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> Sched: <span id="sewDailySched">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="sewDailyProd">-</span></span>
            </div>
          </div>
          <div class="chart-box olk-chart">
            <h3>SEW MTD OLK</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieSewOlk"></svg>
              <div class="pie-center" id="pieSewOlkPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> OLK: <span id="sewOlkQty">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="sewOlkProd">-</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 2: ASSY -->
      <div class="page page-assy">
        <div class="table-wrap">
          <table id="pvsTableAssy">
            <thead id="theadAssy"></thead>
            <tbody id="tbodyAssy"></tbody>
          </table>
        </div>

        <div class="charts-row" id="chartsRowAssy">
          <div class="chart-box assy-chart">
            <h3>ASSY MTD</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieAssyMtd"></svg>
              <div class="pie-center" id="pieAssyMtdPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> Sched: <span id="assyMtdSched">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="assyMtdProd">-</span></span>
            </div>
          </div>
          <div class="chart-box assy-chart">
            <h3>ASSY WTD</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieAssyWtd"></svg>
              <div class="pie-center" id="pieAssyWtdPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> Sched: <span id="assyWtdSched">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="assyWtdProd">-</span></span>
            </div>
          </div>
          <div class="chart-box assy-chart">
            <h3>ASSY Daily</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieAssyDaily"></svg>
              <div class="pie-center" id="pieAssyDailyPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> Sched: <span id="assyDailySched">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="assyDailyProd">-</span></span>
            </div>
          </div>
          <div class="chart-box olk-chart">
            <h3>ASSY MTD OLK</h3>
            <div class="pie-container">
              <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="pieAssyOlk"></svg>
              <div class="pie-center" id="pieAssyOlkPct">-</div>
            </div>
            <div class="chart-legend">
              <span><span class="legend-dot sched"></span> OLK: <span id="assyOlkQty">-</span></span>
              <span><span class="legend-dot prod"></span> Prod: <span id="assyOlkProd">-</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 3: Grouped Totals -->
      <div class="page page-groups">
        <div class="table-wrap">
          <table id="pvsTableGroups">
            <thead id="theadGroups"></thead>
            <tbody id="tbodyGroups"></tbody>
          </table>
        </div>
        <div class="charts-row group-charts" id="groupChartsContainer"></div>
      </div>
    </div>
  </div>

<script>
// This placeholder will be replaced by generate_static_pvs.py
const SNAPSHOT = {"success": true, "date": "2026-02-06", "rows": [{"code": "BR223", "line": "BR223", "category": "SEW", "mtd": {"olk": 13325, "adh_olk_pct": 20.0, "schedule": 2781, "production": 2663.0, "delta": -118.0, "adherence_pct": -4.2}, "wtd": {"schedule": 2781, "production": 2663.0, "delta": -118.0, "adherence_pct": -4.2}, "daily": {"schedule": 556, "production": 640.0, "delta": 84.0, "adherence_pct": 15.1}}, {"code": "FIAT", "line": "FIAT", "category": "SEW", "mtd": {"olk": 23674, "adh_olk_pct": 23.5, "schedule": 6284, "production": 5572.0, "delta": -712.0, "adherence_pct": -11.3}, "wtd": {"schedule": 6284, "production": 5572.0, "delta": -712.0, "adherence_pct": -11.3}, "daily": {"schedule": 1256, "production": 1209.0, "delta": -47.0, "adherence_pct": -3.7}}, {"code": "PO426", "line": "PO426", "category": "SEW", "mtd": {"olk": 8331, "adh_olk_pct": 26.7, "schedule": 3429, "production": 2226.0, "delta": -1203.0, "adherence_pct": -35.1}, "wtd": {"schedule": 3429, "production": 2226.0, "delta": -1203.0, "adherence_pct": -35.1}, "daily": {"schedule": 685, "production": 732.0, "delta": 47.0, "adherence_pct": 6.9}}, {"code": "PIP", "line": "PIP", "category": "SEW", "mtd": {"olk": 0, "adh_olk_pct": 0.0, "schedule": 0, "production": 0.0, "delta": 0.0, "adherence_pct": null}, "wtd": {"schedule": 0, "production": 0.0, "delta": 0.0, "adherence_pct": null}, "daily": {"schedule": 0, "production": 0.0, "delta": 0.0, "adherence_pct": null}}, {"code": "CDPO - SEW", "line": "CDPO - SEW", "category": "SEW", "mtd": {"olk": 23814, "adh_olk_pct": 16.3, "schedule": 4036, "production": 3892.0, "delta": -144.0, "adherence_pct": -3.6}, "wtd": {"schedule": 4036, "production": 3892.0, "delta": -144.0, "adherence_pct": -3.6}, "daily": {"schedule": 807, "production": 1040.0, "delta": 233.0, "adherence_pct": 28.9}}, {"code": "PZ1D", "line": "PZ1D", "category": "SEW", "mtd": {"olk": 11, "adh_olk_pct": 2818.2, "schedule": 0, "production": 310.0, "delta": 310.0, "adherence_pct": null}, "wtd": {"schedule": 0, "production": 310.0, "delta": 310.0, "adherence_pct": null}, "daily": {"schedule": 0, "production": 90.0, "delta": 90.0, "adherence_pct": null}}, {"code": "MAN", "line": "MAN", "category": "SEW", "mtd": {"olk": 17332, "adh_olk_pct": 25.7, "schedule": 4284, "production": 4452.0, "delta": 168.0, "adherence_pct": 3.9}, "wtd": {"schedule": 4284, "production": 4452.0, "delta": 168.0, "adherence_pct": 3.9}, "daily": {"schedule": 856, "production": 1056.0, "delta": 200.0, "adherence_pct": 23.4}}, {"code": "SCANIA", "line": "SCANIA", "category": "SEW", "mtd": {"olk": 7486, "adh_olk_pct": 25.6, "schedule": 1880, "production": 1918.0, "delta": 38.0, "adherence_pct": 2.0}, "wtd": {"schedule": 1880, "production": 1918.0, "delta": 38.0, "adherence_pct": 2.0}, "daily": {"schedule": 376, "production": 560.0, "delta": 184.0, "adherence_pct": 48.9}}, {"code": "RENAULT", "line": "RENAULT", "category": "SEW", "mtd": {"olk": 7412, "adh_olk_pct": 33.5, "schedule": 2398, "production": 2480.0, "delta": 82.0, "adherence_pct": 3.4}, "wtd": {"schedule": 2398, "production": 2480.0, "delta": 82.0, "adherence_pct": 3.4}, "daily": {"schedule": 479, "production": 600.0, "delta": 121.0, "adherence_pct": 25.3}}, {"code": "BJA", "line": "BJA", "category": "SEW", "mtd": {"olk": 3000, "adh_olk_pct": 90.7, "schedule": 5046, "production": 2720.0, "delta": -2326.0, "adherence_pct": -46.1}, "wtd": {"schedule": 5046, "production": 2720.0, "delta": -2326.0, "adherence_pct": -46.1}, "daily": {"schedule": 1009, "production": 600.0, "delta": -409.0, "adherence_pct": -40.5}}, {"code": "KIA - SEW", "line": "KIA - SEW", "category": "SEW", "mtd": {"olk": 2518, "adh_olk_pct": 28.2, "schedule": 646, "production": 710.0, "delta": 64.0, "adherence_pct": 9.9}, "wtd": {"schedule": 646, "production": 710.0, "delta": 64.0, "adherence_pct": 9.9}, "daily": {"schedule": 129, "production": 230.0, "delta": 101.0, "adherence_pct": 78.3}}, {"code": "JLR - SEW", "line": "JLR - SEW", "category": "SEW", "mtd": {"olk": 1728, "adh_olk_pct": 23.5, "schedule": 396, "production": 406.0, "delta": 10.0, "adherence_pct": 2.5}, "wtd": {"schedule": 396, "production": 406.0, "delta": 10.0, "adherence_pct": 2.5}, "daily": {"schedule": 79, "production": 112.0, "delta": 33.0, "adherence_pct": 41.8}}, {"code": "MMA - SEW", "line": "MMA - SEW", "category": "SEW", "mtd": {"olk": 124939, "adh_olk_pct": 16.6, "schedule": 22920, "production": 20719.0, "delta": -2201.0, "adherence_pct": -9.6}, "wtd": {"schedule": 22920, "production": 20719.0, "delta": -2201.0, "adherence_pct": -9.6}, "daily": {"schedule": 4584, "production": 5514.0, "delta": 930.0, "adherence_pct": 20.3}}, {"code": "Opel - SEW", "line": "Opel - SEW", "category": "SEW", "mtd": {"olk": 5160, "adh_olk_pct": 33.9, "schedule": 1329, "production": 1750.0, "delta": 421.0, "adherence_pct": 31.7}, "wtd": {"schedule": 1329, "production": 1750.0, "delta": 421.0, "adherence_pct": 31.7}, "daily": {"schedule": 265, "production": 430.0, "delta": 165.0, "adherence_pct": 62.3}}, {"code": "Volvo - SEW", "line": "Volvo - SEW", "category": "SEW", "mtd": {"olk": 73538, "adh_olk_pct": 9.2, "schedule": 7238, "production": 6745.0, "delta": -493.0, "adherence_pct": -6.8}, "wtd": {"schedule": 7238, "production": 6745.0, "delta": -493.0, "adherence_pct": -6.8}, "daily": {"schedule": 1447, "production": 2080.0, "delta": 633.0, "adherence_pct": 43.7}}, {"code": "Volvo - ASSY", "line": "Volvo - ASSY", "category": "ASSY", "mtd": {"olk": 73538, "adh_olk_pct": 21.0, "schedule": 16351, "production": 15460.0, "delta": -891.0, "adherence_pct": -5.4}, "wtd": {"schedule": 16351, "production": 15460.0, "delta": -891.0, "adherence_pct": -5.4}, "daily": {"schedule": 3270, "production": 3944.0, "delta": 674.0, "adherence_pct": 20.6}}, {"code": "KIA - ASSY", "line": "KIA - ASSY", "category": "ASSY", "mtd": {"olk": 2518, "adh_olk_pct": 39.1, "schedule": 411, "production": 985.0, "delta": 574.0, "adherence_pct": 139.7}, "wtd": {"schedule": 411, "production": 985.0, "delta": 574.0, "adherence_pct": 139.7}, "daily": {"schedule": 82, "production": 156.0, "delta": 74.0, "adherence_pct": 90.2}}, {"code": "CDPO - ASSY", "line": "CDPO - ASSY", "category": "ASSY", "mtd": {"olk": 23814, "adh_olk_pct": 20.8, "schedule": 4231, "production": 4956.0, "delta": 725.0, "adherence_pct": 17.1}, "wtd": {"schedule": 4231, "production": 4956.0, "delta": 725.0, "adherence_pct": 17.1}, "daily": {"schedule": 846, "production": 1116.0, "delta": 270.0, "adherence_pct": 31.9}}, {"code": "JLR - ASSY", "line": "JLR - ASSY", "category": "ASSY", "mtd": {"olk": 1728, "adh_olk_pct": 40.7, "schedule": 406, "production": 704.0, "delta": 298.0, "adherence_pct": 73.4}, "wtd": {"schedule": 406, "production": 704.0, "delta": 298.0, "adherence_pct": 73.4}, "daily": {"schedule": 81, "production": 128.0, "delta": 47.0, "adherence_pct": 58.0}}, {"code": "MMA - ASSY", "line": "MMA - ASSY", "category": "ASSY", "mtd": {"olk": 124939, "adh_olk_pct": 19.4, "schedule": 24965, "production": 24203.0, "delta": -762.0, "adherence_pct": -3.1}, "wtd": {"schedule": 24965, "production": 24203.0, "delta": -762.0, "adherence_pct": -3.1}, "daily": {"schedule": 4993, "production": 5861.0, "delta": 868.0, "adherence_pct": 17.4}}, {"code": "Opel - ASSY", "line": "Opel - ASSY", "category": "ASSY", "mtd": {"olk": 5160, "adh_olk_pct": 33.3, "schedule": 1391, "production": 1716.0, "delta": 325.0, "adherence_pct": 23.4}, "wtd": {"schedule": 1391, "production": 1716.0, "delta": 325.0, "adherence_pct": 23.4}, "daily": {"schedule": 278, "production": 552.0, "delta": 274.0, "adherence_pct": 98.6}}], "generated_at": "2026-02-07 22:35", "totals": {"sew": {"mtd": {"schedule": 62667, "production": 56563.0}, "wtd": {"schedule": 62667, "production": 56563.0}, "daily": {"schedule": 12528, "production": 14893.0}}, "assy": {"mtd": {"schedule": 47755, "production": 48024.0}, "wtd": {"schedule": 47755, "production": 48024.0}, "daily": {"schedule": 9550, "production": 11757.0}}, "other": {"mtd": {"schedule": 0, "production": 0}, "wtd": {"schedule": 0, "production": 0}, "daily": {"schedule": 0, "production": 0}}, "all": {"mtd": {"schedule": 110422, "production": 104587.0}, "wtd": {"schedule": 110422, "production": 104587.0}, "daily": {"schedule": 22078, "production": 26650.0}}}, "group_totals": [{"group": "BJA", "mtd": {"schedule": 5046, "production": 2720.0, "delta": -2326.0, "adherence_pct": -46.1, "olk": 3000, "adh_olk_pct": 90.7}, "wtd": {"schedule": 5046, "production": 2720.0, "delta": -2326.0, "adherence_pct": -46.1}, "daily": {"schedule": 1009, "production": 600.0, "delta": -409.0, "adherence_pct": -40.5}}, {"group": "CDPO", "mtd": {"schedule": 8267, "production": 8848.0, "delta": 581.0, "adherence_pct": 7.0, "olk": 23814, "adh_olk_pct": 37.2}, "wtd": {"schedule": 8267, "production": 8848.0, "delta": 581.0, "adherence_pct": 7.0}, "daily": {"schedule": 1653, "production": 2156.0, "delta": 503.0, "adherence_pct": 30.4}}, {"group": "CV", "mtd": {"schedule": 8562, "production": 8850.0, "delta": 288.0, "adherence_pct": 3.4, "olk": 0, "adh_olk_pct": 0.0}, "wtd": {"schedule": 8562, "production": 8850.0, "delta": 288.0, "adherence_pct": 3.4}, "daily": {"schedule": 1712, "production": 2216.0, "delta": 504.0, "adherence_pct": 29.4}}, {"group": "JLR", "mtd": {"schedule": 802, "production": 1110.0, "delta": 308.0, "adherence_pct": 38.4, "olk": 1728, "adh_olk_pct": 64.2}, "wtd": {"schedule": 802, "production": 1110.0, "delta": 308.0, "adherence_pct": 38.4}, "daily": {"schedule": 160, "production": 240.0, "delta": 80.0, "adherence_pct": 50.0}}, {"group": "KIA", "mtd": {"schedule": 1057, "production": 1695.0, "delta": 638.0, "adherence_pct": 60.4, "olk": 2518, "adh_olk_pct": 67.3}, "wtd": {"schedule": 1057, "production": 1695.0, "delta": 638.0, "adherence_pct": 60.4}, "daily": {"schedule": 211, "production": 386.0, "delta": 175.0, "adherence_pct": 82.9}}, {"group": "LUCENEC", "mtd": {"schedule": 12494, "production": 10461.0, "delta": -2033.0, "adherence_pct": -16.3, "olk": 0, "adh_olk_pct": 0.0}, "wtd": {"schedule": 12494, "production": 10461.0, "delta": -2033.0, "adherence_pct": -16.3}, "daily": {"schedule": 2498, "production": 2581.0, "delta": 83.0, "adherence_pct": 3.3}}, {"group": "MMA", "mtd": {"schedule": 47885, "production": 44922.0, "delta": -2963.0, "adherence_pct": -6.2, "olk": 124939, "adh_olk_pct": 36.0}, "wtd": {"schedule": 47885, "production": 44922.0, "delta": -2963.0, "adherence_pct": -6.2}, "daily": {"schedule": 9577, "production": 11375.0, "delta": 1798.0, "adherence_pct": 18.8}}, {"group": "OPEL", "mtd": {"schedule": 2720, "production": 3466.0, "delta": 746.0, "adherence_pct": 27.4, "olk": 5160, "adh_olk_pct": 67.2}, "wtd": {"schedule": 2720, "production": 3466.0, "delta": 746.0, "adherence_pct": 27.4}, "daily": {"schedule": 544, "production": 982.0, "delta": 438.0, "adherence_pct": 80.5}}, {"group": "PIP", "mtd": {"schedule": 0, "production": 0.0, "delta": 0.0, "adherence_pct": null, "olk": 0, "adh_olk_pct": 0.0}, "wtd": {"schedule": 0, "production": 0.0, "delta": 0.0, "adherence_pct": null}, "daily": {"schedule": 0, "production": 0.0, "delta": 0.0, "adherence_pct": null}}, {"group": "PZ1D", "mtd": {"schedule": 0, "production": 310.0, "delta": 310.0, "adherence_pct": null, "olk": 11, "adh_olk_pct": 2818.2}, "wtd": {"schedule": 0, "production": 310.0, "delta": 310.0, "adherence_pct": null}, "daily": {"schedule": 0, "production": 90.0, "delta": 90.0, "adherence_pct": null}}, {"group": "VOLVO", "mtd": {"schedule": 23589, "production": 22205.0, "delta": -1384.0, "adherence_pct": -5.9, "olk": 73538, "adh_olk_pct": 30.2}, "wtd": {"schedule": 23589, "production": 22205.0, "delta": -1384.0, "adherence_pct": -5.9}, "daily": {"schedule": 4717, "production": 6024.0, "delta": 1307.0, "adherence_pct": 27.7}}], "olk_totals": {"sew": {"olk": 312268, "production": 56563.0, "adh_olk_pct": 18.1}, "assy": {"olk": 231697, "production": 48024.0, "adh_olk_pct": 20.7}}};

const fmtInt = n => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n||0);
const fmtPct = n => {
  if (n === null || n === undefined || !Number.isFinite(n)) return 'N/A';
  return `${Number(n).toFixed(0)}%`;
};

function getOlkAdherenceColor(pct) {
  const green = { r: 46, g: 204, b: 113 };
  const yellow = { r: 241, g: 196, b: 15 };
  const red = { r: 231, g: 76, b: 60 };

  let val = Number(pct);
  if (!isFinite(val)) val = 0;

  const diff = Math.abs(val - 100);
  if (diff <= 3) return { ...green };
  if (diff <= 5) return { ...yellow };
  return { ...red };
}

function getOlkAdherenceStyle(pct) {
  const val = Number(pct);
  const diff = isFinite(val) ? Math.abs(val - 100) : 999;
  const c = getOlkAdherenceColor(val || 0);
  const bg = `rgb(${c.r}, ${c.g}, ${c.b})`;
  const text = (diff > 3 && diff <= 5) ? '#000' : '#fff';
  return `background-color: ${bg}; color: ${text};`;
}

function getAdherenceStyle(pct) {
  if (pct === null || pct === undefined || !Number.isFinite(pct)) {
    return 'background-color: rgba(255,255,255,0.08); color: #dddddd;';
  }
  const absPct = 100 + Number(pct);
  const diff = Math.abs(absPct - 100);
  const green = { r: 46, g: 204, b: 113 };
  const yellow = { r: 241, g: 196, b: 15 };
  const red = { r: 231, g: 76, b: 60 };

  let c = red;
  let text = '#fff';
  if (diff <= 3) {
    c = green;
  } else if (diff < 5) {
    c = yellow;
    text = '#000';
  }
  const bg = `rgb(${c.r}, ${c.g}, ${c.b})`;
  return `background-color: ${bg}; color: ${text};`;
}

function deltaClass(d){ return d >= 0 ? 'delta-pos' : 'delta-neg'; }

function buildHeader(theadId, firstLabel) {
  const thead = document.getElementById(theadId);
  if (!thead) return;
  const label = firstLabel || 'Line';
  thead.innerHTML = `
    <tr>
      <th rowspan="2">${label}</th>
      <th class="group" colspan="5">MTD</th>
      <th class="group" colspan="4">WTD</th>
      <th class="group" colspan="4">Daily PVS</th>
    </tr>
    <tr>
      <th>OLK</th><th>Sch</th><th>Prod</th><th>Delta</th><th>Adh %</th>
      <th>Schedule</th><th>Production</th><th>Delta</th><th>Adh %</th>
      <th>Sched</th><th>Prod</th><th>Delta</th><th>Adh %</th>
    </tr>`;
}

function renderRowsInto(rows, tbodyId){
  const tb = document.getElementById(tbodyId);
  tb.innerHTML = '';

  for (let i = 0; i < rows.length; i++){
    const r = rows[i];
    const cat = r.category || 'OTHER';

    const tr = document.createElement('tr');
    // Apply category class for coloring
    tr.classList.add('cat-' + cat.toLowerCase());

    const c = (html, cls='', style='') => {
      const td = document.createElement('td');
      if(cls) td.className = cls;
      if(style) td.style.cssText = style;
      td.innerHTML = html;
      return td;
    };

    tr.appendChild(c(r.line));

    const mtdStyle = getAdherenceStyle(r.mtd.adherence_pct);
    tr.appendChild(c(fmtInt(r.mtd.olk || 0), 'num'));
    tr.appendChild(c(fmtInt(r.mtd.schedule), 'num'));
    tr.appendChild(c(fmtInt(r.mtd.production), 'num'));
    tr.appendChild(c(fmtInt(r.mtd.delta), `num ${deltaClass(r.mtd.delta)}`));
    tr.appendChild(c(fmtPct(r.mtd.adherence_pct), 'num', mtdStyle));

    // WTD
    const wtdStyle = getAdherenceStyle(r.wtd.adherence_pct);
    tr.appendChild(c(fmtInt(r.wtd.schedule), 'num'));
    tr.appendChild(c(fmtInt(r.wtd.production), 'num'));
    tr.appendChild(c(fmtInt(r.wtd.delta), `num ${deltaClass(r.wtd.delta)}`));
    tr.appendChild(c(fmtPct(r.wtd.adherence_pct), 'num', wtdStyle));

    // Daily
    const dailyStyle = getAdherenceStyle(r.daily.adherence_pct);
    tr.appendChild(c(fmtInt(r.daily.schedule), 'num'));
    tr.appendChild(c(fmtInt(r.daily.production), 'num'));
    tr.appendChild(c(fmtInt(r.daily.delta), `num ${deltaClass(r.daily.delta)}`));
    tr.appendChild(c(fmtPct(r.daily.adherence_pct), 'num', dailyStyle));

    tb.appendChild(tr);
  }
}

function renderRows(rows){
  const sewRows = rows.filter(r => r.category === 'SEW');
  const assyRows = rows.filter(r => r.category === 'ASSY');

  renderRowsInto(sewRows, 'tbodySew');
  renderRowsInto(assyRows, 'tbodyAssy');
}

function renderGroupRows(groups){
  const tb = document.getElementById('tbodyGroups');
  if (!tb) return;
  tb.innerHTML = '';

  for (let i = 0; i < groups.length; i++){
    const g = groups[i];

    const tr = document.createElement('tr');
    const c = (html, cls='', style='') => {
      const td = document.createElement('td');
      if(cls) td.className = cls;
      if(style) td.style.cssText = style;
      td.innerHTML = html;
      return td;
    };

    tr.appendChild(c(g.group || ''));

    const mtd = g.mtd || {};
    const wtd = g.wtd || {};
    const daily = g.daily || {};

    const mtdStyle = getAdherenceStyle(mtd.adherence_pct);
    tr.appendChild(c(fmtInt(mtd.olk || 0), 'num'));
    tr.appendChild(c(fmtInt(mtd.schedule || 0), 'num'));
    tr.appendChild(c(fmtInt(mtd.production || 0), 'num'));
    tr.appendChild(c(fmtInt(mtd.delta || 0), `num ${deltaClass(mtd.delta || 0)}`));
    tr.appendChild(c(fmtPct(mtd.adherence_pct), 'num', mtdStyle));

    const wtdStyle = getAdherenceStyle(wtd.adherence_pct);
    tr.appendChild(c(fmtInt(wtd.schedule || 0), 'num'));
    tr.appendChild(c(fmtInt(wtd.production || 0), 'num'));
    tr.appendChild(c(fmtInt(wtd.delta || 0), `num ${deltaClass(wtd.delta || 0)}`));
    tr.appendChild(c(fmtPct(wtd.adherence_pct), 'num', wtdStyle));

    const dailyStyle = getAdherenceStyle(daily.adherence_pct);
    tr.appendChild(c(fmtInt(daily.schedule || 0), 'num'));
    tr.appendChild(c(fmtInt(daily.production || 0), 'num'));
    tr.appendChild(c(fmtInt(daily.delta || 0), `num ${deltaClass(daily.delta || 0)}`));
    tr.appendChild(c(fmtPct(daily.adherence_pct), 'num', dailyStyle));

    tb.appendChild(tr);
  }
}

function addGaugeNeedle(svg, cx, cy, r, absPct) {
  if (absPct === null || absPct === undefined || !isFinite(absPct)) return;

  const clamped = Math.max(0, Math.min(Number(absPct), 200));
  const angle = (-150 + (clamped / 200) * 300) * Math.PI / 180;
  const needleLen = r - 6;
  const x = cx + needleLen * Math.cos(angle);
  const y = cy + needleLen * Math.sin(angle);

  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', cx);
  line.setAttribute('y1', cy);
  line.setAttribute('x2', x);
  line.setAttribute('y2', y);
  line.setAttribute('stroke', '#ffffff');
  line.setAttribute('stroke-width', 2);
  svg.appendChild(line);

  const hub = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  hub.setAttribute('cx', cx);
  hub.setAttribute('cy', cy);
  hub.setAttribute('r', 3);
  hub.setAttribute('fill', '#ffffff');
  svg.appendChild(hub);
}

// Draw a donut/pie chart showing production vs schedule
function drawPieChart(svgId, centerId, sched, prod) {
  const svg = document.getElementById(svgId);
  const centerEl = document.getElementById(centerId);
  if (!svg || !centerEl) return;

  svg.innerHTML = '';
  const cx = 60, cy = 60, r = 50, strokeWidth = 16;
  const circumference = 2 * Math.PI * r;

  // Background circle (schedule = 100%)
  const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  bgCircle.setAttribute('cx', cx);
  bgCircle.setAttribute('cy', cy);
  bgCircle.setAttribute('r', r);
  bgCircle.setAttribute('fill', 'none');
  bgCircle.setAttribute('stroke', '#02252b');
  bgCircle.setAttribute('stroke-width', strokeWidth);
  svg.appendChild(bgCircle);

  const hasSched = sched > 0;
  const ratio = hasSched ? Math.min(prod / sched, 1.5) : 0;
  const absPct = hasSched ? (prod / sched) * 100 : null;
  const c = getOlkAdherenceColor((absPct || 0));

  const prodArc = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  prodArc.setAttribute('cx', cx);
  prodArc.setAttribute('cy', cy);
  prodArc.setAttribute('r', r);
  prodArc.setAttribute('fill', 'none');
  prodArc.setAttribute('stroke', `rgb(${c.r}, ${c.g}, ${c.b})`);
  prodArc.setAttribute('stroke-width', strokeWidth);
  prodArc.setAttribute('stroke-dasharray', `${circumference * Math.min(ratio, 1)} ${circumference}`);
  prodArc.setAttribute('stroke-linecap', 'round');
  svg.appendChild(prodArc);

  if (absPct === null) {
    centerEl.textContent = 'N/A';
    centerEl.style.color = '#dddddd';
  } else {
    const displayPct = Math.round(absPct || 0);
    centerEl.textContent = displayPct + '%';
    centerEl.style.color = `rgb(${c.r}, ${c.g}, ${c.b})`;
  }
}

function drawOlkPieChart(svgId, centerId, olkQty, prodQty, adhOlkPct) {
  const svg = document.getElementById(svgId);
  const centerEl = document.getElementById(centerId);
  if (!svg || !centerEl) return;

  svg.innerHTML = '';
  const cx = 60, cy = 60, r = 50, strokeWidth = 16;
  const circumference = 2 * Math.PI * r;

  const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  bgCircle.setAttribute('cx', cx);
  bgCircle.setAttribute('cy', cy);
  bgCircle.setAttribute('r', r);
  bgCircle.setAttribute('fill', 'none');
  bgCircle.setAttribute('stroke', '#02252b');
  bgCircle.setAttribute('stroke-width', strokeWidth);
  svg.appendChild(bgCircle);

  const pctRatio = olkQty > 0 ? Math.min(prodQty / olkQty, 1.5) : 0;
  const c = getOlkAdherenceColor(adhOlkPct || 0);
  const prodArc = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  prodArc.setAttribute('cx', cx);
  prodArc.setAttribute('cy', cy);
  prodArc.setAttribute('r', r);
  prodArc.setAttribute('fill', 'none');
  prodArc.setAttribute('stroke', `rgb(${c.r}, ${c.g}, ${c.b})`);
  prodArc.setAttribute('stroke-width', strokeWidth);
  prodArc.setAttribute('stroke-dasharray', `${circumference * Math.min(pctRatio, 1)} ${circumference}`);
  prodArc.setAttribute('stroke-linecap', 'round');
  svg.appendChild(prodArc);

  const displayPct = Math.round(adhOlkPct || 0);
  centerEl.textContent = displayPct + '%';
  centerEl.style.color = `rgb(${c.r}, ${c.g}, ${c.b})`;
}

function renderPieCharts(totals, olkTotals) {
  if (!totals) return;

  const sew = totals.sew || {};
  const assy = totals.assy || {};

  const sewOlk = (olkTotals && olkTotals.sew) || {};
  const assyOlk = (olkTotals && olkTotals.assy) || {};

  const getWindow = (bucket, key) => {
    const win = bucket && bucket[key] ? bucket[key] : {};
    return {
      schedule: win.schedule || 0,
      production: win.production || 0,
    };
  };

  // SEW windows
  const sewMtd = getWindow(sew, 'mtd');
  const sewWtd = getWindow(sew, 'wtd');
  const sewDaily = getWindow(sew, 'daily');

  drawPieChart('pieSewMtd', 'pieSewMtdPct', sewMtd.schedule, sewMtd.production);
  document.getElementById('sewMtdSched').textContent = fmtInt(sewMtd.schedule);
  document.getElementById('sewMtdProd').textContent = fmtInt(sewMtd.production);

  drawPieChart('pieSewWtd', 'pieSewWtdPct', sewWtd.schedule, sewWtd.production);
  document.getElementById('sewWtdSched').textContent = fmtInt(sewWtd.schedule);
  document.getElementById('sewWtdProd').textContent = fmtInt(sewWtd.production);

  drawPieChart('pieSewDaily', 'pieSewDailyPct', sewDaily.schedule, sewDaily.production);
  document.getElementById('sewDailySched').textContent = fmtInt(sewDaily.schedule);
  document.getElementById('sewDailyProd').textContent = fmtInt(sewDaily.production);

  // ASSY windows
  const assyMtd = getWindow(assy, 'mtd');
  const assyWtd = getWindow(assy, 'wtd');
  const assyDaily = getWindow(assy, 'daily');

  drawPieChart('pieAssyMtd', 'pieAssyMtdPct', assyMtd.schedule, assyMtd.production);
  document.getElementById('assyMtdSched').textContent = fmtInt(assyMtd.schedule);
  document.getElementById('assyMtdProd').textContent = fmtInt(assyMtd.production);

  drawPieChart('pieAssyWtd', 'pieAssyWtdPct', assyWtd.schedule, assyWtd.production);
  document.getElementById('assyWtdSched').textContent = fmtInt(assyWtd.schedule);
  document.getElementById('assyWtdProd').textContent = fmtInt(assyWtd.production);

  drawPieChart('pieAssyDaily', 'pieAssyDailyPct', assyDaily.schedule, assyDaily.production);
  document.getElementById('assyDailySched').textContent = fmtInt(assyDaily.schedule);
  document.getElementById('assyDailyProd').textContent = fmtInt(assyDaily.production);

  const sewOlkQty = sewOlk.olk || 0;
  const sewOlkProd = sewOlk.production || 0;
  const sewAdhOlk = sewOlk.adh_olk_pct || 0;
  drawOlkPieChart('pieSewOlk', 'pieSewOlkPct', sewOlkQty, sewOlkProd, sewAdhOlk);
  const sewOlkQtyEl = document.getElementById('sewOlkQty');
  const sewOlkProdEl = document.getElementById('sewOlkProd');
  if (sewOlkQtyEl) sewOlkQtyEl.textContent = fmtInt(sewOlkQty);
  if (sewOlkProdEl) sewOlkProdEl.textContent = fmtInt(sewOlkProd);

  const assyOlkQty = assyOlk.olk || 0;
  const assyOlkProd = assyOlk.production || 0;
  const assyAdhOlk = assyOlk.adh_olk_pct || 0;
  drawOlkPieChart('pieAssyOlk', 'pieAssyOlkPct', assyOlkQty, assyOlkProd, assyAdhOlk);
  const assyOlkQtyEl = document.getElementById('assyOlkQty');
  const assyOlkProdEl = document.getElementById('assyOlkProd');
  if (assyOlkQtyEl) assyOlkQtyEl.textContent = fmtInt(assyOlkQty);
  if (assyOlkProdEl) assyOlkProdEl.textContent = fmtInt(assyOlkProd);
}

// Group pies (MTD only), one donut per group total on page 3
function renderGroupPieCharts(groups) {
  const container = document.getElementById('groupChartsContainer');
  if (!container) return;

  container.innerHTML = '';
  if (!Array.isArray(groups) || !groups.length) return;

  // Drop technical OTHER bucket if present; keep the 13 business groups
  const filtered = groups.filter(g => g && g.group && g.group !== 'OTHER');

  filtered.forEach((g, idx) => {
    const mtd = g.mtd || {};
    const sched = mtd.schedule || 0;
    const prod = mtd.production || 0;

    const svgId = `pieGroup${idx}`;
    const centerId = `pieGroupPct${idx}`;
    const schedId = `group${idx}Sched`;
    const prodId = `group${idx}Prod`;

    const box = document.createElement('div');
    box.className = 'chart-box total-chart';
    box.innerHTML = `
      <h3>${g.group}</h3>
      <div class="pie-container">
        <svg class="pie-svg" width="120" height="120" viewBox="0 0 120 120" id="${svgId}"></svg>
        <div class="pie-center" id="${centerId}">-</div>
      </div>
      <div class="chart-legend">
        <span><span class="legend-dot sched"></span> Sched: <span id="${schedId}">-</span></span>
        <span><span class="legend-dot prod"></span> Prod: <span id="${prodId}">-</span></span>
      </div>
    `;

    container.appendChild(box);

    drawPieChart(svgId, centerId, sched, prod);
    document.getElementById(schedId).textContent = fmtInt(sched);
    document.getElementById(prodId).textContent = fmtInt(prod);
  });
}

function loadFromSnapshot(){
  const data = SNAPSHOT || {};
  const rows = Array.isArray(data.rows) ? data.rows : [];
  const totals = data.totals || null;
  const groupTotals = Array.isArray(data.group_totals) ? data.group_totals : [];
  const olkTotals = data.olk_totals || null;
  const lastUpEl = document.getElementById('lastUp');

  if (data.generated_at) {
    lastUpEl.textContent = data.generated_at + ` (as of ${data.date || ''})`;
  } else if (data.date) {
    lastUpEl.textContent = data.date;
  } else {
    lastUpEl.textContent = 'n/a';
  }

  renderRows(rows);
  renderPieCharts(totals, olkTotals);
  renderGroupRows(groupTotals);
  renderGroupPieCharts(groupTotals);
}

function manualRefresh(){
  // For static snapshot this just re-renders from embedded JSON
  loadFromSnapshot();
}

buildHeader('theadSew', 'Line');
buildHeader('theadAssy', 'Line');
buildHeader('theadGroups', 'Group');
loadFromSnapshot();

// Page rotation (SEW -> ASSY -> GROUPS)
const PAGE_ORDER = ['sew', 'assy', 'groups'];

function showPage(name){
  PAGE_ORDER.forEach(p => {
    const el = document.querySelector('.page-' + p);
    if (el) el.classList.toggle('active', p === name);
  });
}

function startRotation(){
  let idx = 0;
  showPage(PAGE_ORDER[idx]);
  setInterval(() => {
    idx = (idx + 1) % PAGE_ORDER.length;
    showPage(PAGE_ORDER[idx]);
  }, 30000);
}

startRotation();

// Auto-reload the page every 30 minutes to pick up new snapshots
const RELOAD_INTERVAL_MS = 30 * 60 * 1000;
setTimeout(function(){
  try {
    const url = window.location.pathname + '?t=' + Date.now();
    window.location.replace(url);
  } catch (e) {
    window.location.reload();
  }
}, RELOAD_INTERVAL_MS);
</script>
</body>
</html>
