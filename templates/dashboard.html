<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourly Production Monitoring - Adient Loznica</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="{{ url_for('static', filename='chart.umd.min.js') }}?v={{ version }}&t={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='chartjs-plugin-datalabels.min.js') }}?v={{ version }}&t={{ timestamp }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #004851 0%, #002b30 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header .title {
            font-size: 1.6em;
            color: #C4D600;
            text-align: center;
            white-space: nowrap;
        }
        .header .left, .header .right {
            display: flex;
            gap: 14px;
            align-items: center;
            color: #bbe1fa;
            font-size: 0.95em;
        }
        .header .left { justify-content: flex-start; }
        .header .right { justify-content: flex-end; }

        /* Per-page containers */
        .page { display: none; }
        .page.active { display: block; }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-indicator.error {
            background: #f44336;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            max-width: 100%;
            margin: 0 auto;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            color: #1b262c;
        }

        .chart-card h2 {
            margin-bottom: 20px;
            color: #004851;
            font-size: 1.5em;
            border-bottom: 3px solid #C4D600;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 600px;
            margin-top: 20px;
        }

        .heatmap-container {
            position: relative;
            height: 700px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #004851;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td:first-child, th:first-child {
            text-align: left;
            font-weight: 600;
            color: #004851;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-weight: 700;
            border-radius: 4px;
            transition: transform 0.2s;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.75);
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #3282b8;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #c62828;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #006B75 0%, #004851 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 1;
            color: #f5f7f9;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
        }

        .refresh-info {
            font-size: 0.9em;
            color: #bbe1fa;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="left">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Loading...</span>
        </div>
        <div class="title">üöó Hourly Production Monitoring - Adient Loznica</div>
        <div class="right">
            <span id="lastUpdate">Last Update: --:--:--</span>
            <span id="nextRefresh">Next refresh in: --:--</span>
            <span id="pageInfo">Page 1/4</span>
        </div>
    </div>

    <div class="dashboard-container">
        <div id="pageHeatmap" class="page active">
            <div class="chart-card">
                <h2>üìä Production Heatmap - Hourly Distribution</h2>
                <div class="table-container" id="heatmapContainer">
                    <div class="loading">Loading data...</div>
                </div>
            </div>
        </div>

        <div id="pageProject" class="page">
            <div class="chart-card">
                <h2>üìà Total Production by Project</h2>
                <div class="chart-container">
                    <canvas id="projectChart"></canvas>
                </div>
            </div>
        </div>

        <div id="pageTime" class="page">
            <div class="chart-card">
                <h2>‚è∞ Production per Hour</h2>
                <div class="chart-container">
                    <canvas id="timeSlotChart"></canvas>
                </div>
            </div>
        </div>

        <div id="pageStats" class="page">
            <div class="chart-card">
                <h2>üìä Key Metrics</h2>
                <div id="statsContainer" class="stats-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let projectChart = null;
        let timeSlotChart = null;
        const REFRESH_INTERVAL = 15 * 60 * 1000; // 15 minutes in milliseconds
        let dashboardData = [];
        let currentPage = 0; // 0..3
        let slideshowTimer = null;
        const PAGES = ['pageHeatmap','pageProject','pageTime','pageStats'];
        const SLIDESHOW_INTERVAL_MS = 60000; // 60s per page

        // Color palette - Adient brand colors with variations
        const colors = [
            '#C4D600', '#A8C800', '#8FB300', '#006B75', '#004851',
            '#00858F', '#C4D600', '#A8C800', '#006B75', '#004851',
            '#8FB300', '#00858F', '#C4D600', '#006B75', '#A8C800',
            '#E7E9ED', '#36A2EB'
        ];

        // Fetch and display data
        async function fetchData() {
            try {
                updateStatus('loading', 'Fetching data...');
                
                const response = await fetch('/api/production-data?_=' + Date.now(), { cache: 'no-store' });
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('success', 'Connected');
                    displayData(result.data, result.timestamp);
                    updateLastUpdate(result.timestamp);
                } else {
                    updateStatus('error', 'Error: ' + result.error);
                    showError(result.error);
                }
            } catch (error) {
                updateStatus('error', 'Connection failed');
                showError(error.message);
            }
        }

        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            if (status === 'error') {
                indicator.classList.add('error');
            }
            
            statusText.textContent = text;
        }

        function updateLastUpdate(timestamp) {
            document.getElementById('lastUpdate').textContent = `Last Update: ${timestamp}`;
        }

        function showPage(idx) {
            currentPage = ((idx % PAGES.length) + PAGES.length) % PAGES.length;
            PAGES.forEach((id, i) => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('active', i === currentPage);
            });
            document.getElementById('pageInfo').textContent = `Page ${currentPage+1}/${PAGES.length}`;
        }

        function startSlideshow() {
            if (slideshowTimer) clearInterval(slideshowTimer);
            slideshowTimer = setInterval(() => {
                showPage(currentPage + 1);
            }, SLIDESHOW_INTERVAL_MS);
        }

        function showError(message) {
            const container = document.querySelector('.dashboard-container');
            container.innerHTML = `
                <div class="chart-card">
                    <div class="error">
                        <h3>‚ö†Ô∏è Error Loading Data</h3>
                        <p>${message}</p>
                        <p style="margin-top: 10px;">Please check your database connection settings in dashboard_server.py</p>
                    </div>
                </div>
            `;
        }

        function displayData(data, timestamp) {
            if (!data || data.length === 0) {
                showError('No data available for today');
                return;
            }

            // Calculate statistics
            displayStats(data);

            // Render all components and show page 1
            dashboardData = data;
            displayHeatmap(dashboardData); // full dataset on one page
            displayProjectChart(dashboardData);
            displayTimeSlotChart(dashboardData);
            showPage(0);
            startSlideshow();

            // KPIs are shown on page 4 via stats grid
        }

        function displayStats(data) {
            const timeSlots = ['6-7', '7-8', '8-9', '9-10', '10-11', '11-12', '12-13', '13-14', '14-22', 'II Shift'];
            
            let totalProduction = 0;
            let activeProjects = data.length;
            let peakHour = '';
            let peakValue = 0;

            // Calculate totals per time slot
            const timeSlotTotals = {};
            timeSlots.forEach(slot => {
                timeSlotTotals[slot] = data.reduce((sum, row) => sum + (row[slot] || 0), 0);
                if (timeSlotTotals[slot] > peakValue) {
                    peakValue = timeSlotTotals[slot];
                    peakHour = slot;
                }
                totalProduction += timeSlotTotals[slot];
            });

            const statsHTML = `
                <div class="stat-card">
                    <div class="value">${totalProduction.toLocaleString()}</div>
                    <div class="label">Total Production</div>
                </div>
                <div class="stat-card">
                    <div class="value">${activeProjects}</div>
                    <div class="label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="value">${peakHour}</div>
                    <div class="label">Peak Hour</div>
                </div>
                <div class="stat-card">
                    <div class="value">${peakValue.toLocaleString()}</div>
                    <div class="label">Peak Production</div>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        function displayHeatmap(data) {
            const timeSlots = ['6-7', '7-8', '8-9', '9-10', '10-11', '11-12', '12-13', '13-14', '14-22', 'II Shift'];
            
            // Find max value for color scaling
            let maxValue = 0;
            data.forEach(row => {
                timeSlots.forEach(slot => {
                    if (row[slot] > maxValue) maxValue = row[slot];
                });
            });

            let html = '<table><thead><tr><th>Project</th>';
            timeSlots.forEach(slot => {
                html += `<th>${slot}</th>`;
            });
            html += '<th>Total</th></tr></thead><tbody>';

            data.forEach(row => {
                html += `<tr><td>${row.Project}</td>`;
                let rowTotal = 0;
                
                timeSlots.forEach(slot => {
                    const raw = row[slot];
                    const v = Number(raw);
                    const value = isNaN(v) ? 0 : v;
                    rowTotal += value;
                    const intensity = maxValue > 0 ? (value / maxValue) : 0;
                    const bgColor = getHeatmapColor(intensity);
                    const textColor = value > 0 ? '#fff' : 'rgba(255,255,255,0.85)';
                    
                    html += `<td class="heatmap-cell" style="background-color: ${bgColor}; color: ${textColor}; text-shadow: 0 1px 2px rgba(0,0,0,0.75)">
                        ${value > 0 ? value.toFixed(0) : '-'}
                    </td>`;
                });
                
                html += `<td style="font-weight: bold; background: #f0f0f0;">${rowTotal.toFixed(0)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('heatmapContainer').innerHTML = html;
        }

        function getHeatmapColor(intensity) {
            // Color gradient from light lime green to dark teal (Adient colors)
            const r = Math.round(196 - (196 - 0) * intensity);
            const g = Math.round(214 - (214 - 72) * intensity);
            const b = Math.round(0 - (0 - 81) * intensity);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function displayTable(data) {
            const timeSlots = ['6-7', '7-8', '8-9', '9-10', '10-11', '11-12', '12-13', '13-14', '14-22', 'II Shift'];
            
            let html = '<table><thead><tr><th>Project</th>';
            timeSlots.forEach(slot => {
                html += `<th>${slot}</th>`;
            });
            html += '<th>Total</th></tr></thead><tbody>';

            data.forEach(row => {
                html += `<tr><td>${row.Project}</td>`;
                let rowTotal = 0;
                
                timeSlots.forEach(slot => {
                    const raw = row[slot];
                    const v = Number(raw);
                    const value = isNaN(v) ? 0 : v;
                    rowTotal += value;
                    html += `<td>${value.toFixed(0)}</td>`;
                });
                
                html += `<td style="font-weight: bold;">${rowTotal.toFixed(0)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        function displayProjectChart(data) {
            const ctx = document.getElementById('projectChart').getContext('2d');
            const timeSlots = ['6-7', '7-8', '8-9', '9-10', '10-11', '11-12', '12-13', '13-14', '14-22', 'II Shift'];
            
            // Calculate totals per project
            const projects = data.map(row => row.Project);
            const totals = data.map(row => {
                return timeSlots.reduce((sum, slot) => sum + (row[slot] || 0), 0);
            });

            if (projectChart) {
                projectChart.destroy();
            }

            projectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: projects,
                    datasets: [{
                        label: 'Total Production',
                        data: totals,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Production: ${context.parsed.y.toLocaleString()} units`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function displayTimeSlotChart(data) {
            const ctx = document.getElementById('timeSlotChart').getContext('2d');
            const timeSlots = ['6-7', '7-8', '8-9', '9-10', '10-11', '11-12', '12-13', '13-14', '14-22', 'II Shift'];
            
            // Calculate totals per time slot
            const totals = timeSlots.map(slot => {
                return data.reduce((sum, row) => sum + (row[slot] || 0), 0);
            });

            if (timeSlotChart) {
                timeSlotChart.destroy();
            }

            timeSlotChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeSlots,
                    datasets: [{
                        label: 'Production by Hour',
                        data: totals,
                        backgroundColor: 'rgba(50, 130, 184, 0.2)',
                        borderColor: 'rgba(50, 130, 184, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgba(50, 130, 184, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Production: ${context.parsed.y.toLocaleString()} units`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize dashboard
        fetchData();

        // Auto-refresh every 15 minutes
        setInterval(fetchData, REFRESH_INTERVAL);

        // Show countdown timer in header (#nextRefresh)
        let secondsRemaining = REFRESH_INTERVAL / 1000;
        setInterval(() => {
            secondsRemaining--;
            if (secondsRemaining <= 0) {
                secondsRemaining = REFRESH_INTERVAL / 1000;
            }
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            const el = document.getElementById('nextRefresh');
            if (el) el.textContent = `Next refresh in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    </script>
</body>
</html>
